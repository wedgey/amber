<%= form_for(farm) do |f| %>
  <% if farm.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(farm.errors.count, "error") %> prohibited this farm from being saved:</h2>

      <ul>
      <% farm.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= f.label :name %>
    <%= f.text_field :name %>
  </div>

  <div class="field">
    <%= f.label :farm_code, "Farm code (Optional)" %>
    <%= f.text_field :farm_code %>
  </div>

  <div class="field">
    <%= f.label :size %>
    <%= f.text_field :size %>
  </div>

  <div class="field input-lat" id="input-lat">
    <%= f.label :lat, "Latitude" %>
    <%= f.text_field :lat %>
  </div>

  <div class="field input-lng">
    <%= f.label :lng, "Longtitude" %>
    <%= f.text_field :lng %>
  </div>


  <div class="actions">
    <%= f.submit %>
  </div>
<% end %>

<div id="map" class="center-block"></div>



<script>
  var map;
  var marker;
  var geocoder;
  var infowindow;

  function initMap() {
    geocoder = new google.maps.Geocoder();

    map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: 4.5076156, lng: 114.4846021},
      zoom: 10
    });

    marker = new google.maps.Marker({
      map: map,
      draggable: true,
      animation: google.maps.Animation.DROP,
      position: {lat: 4.5076156, lng: 114.4846021}
    });
    // marker.addListener('click', toggleBounce);

    infowindow = new google.maps.InfoWindow({
      content: 'contentString'
    });

    marker.addListener('click', function() {
      infowindow.open(map, marker);
    });

    marker.addListener('dragend', function (evt) {
      console.log(evt.latLng.lat() + ' ' + evt.latLng.lng());

      $('#farm_lat').val(evt.latLng.lat());
      $('#farm_lng').val(evt.latLng.lng());

      geocodePosition(marker.getPosition());

    
    });

  }


  function geocodePosition(pos) {
  geocoder.geocode({
    latLng: pos
  }, function(responses) {
    if (responses && responses.length > 0) {
      infowindow.setContent(responses[0].formatted_address);
    } else {
      infowindow.setContent('Cannot determine address at this location.');
    }
  });
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=<%=Rails.application.secrets.GGMAP_APP_KEY %>
&callback=initMap"
async defer></script>